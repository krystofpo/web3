


~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

localhost:8080/h2/console
JDBC URL: jdbc:h2:mem:testdb
User Name: sa
Pasword: <leave this empty>


~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~


http://javasampleapproach.com/spring-framework/spring-boot/integrate-h2-database-springboot-spring-jpa-embedded-mode
peknej navod, h2 uklada do souboru takze data zustavaji
ale nema tam list

dobrej uvod do relacnich db a jpa
http://www.springboottutorial.com/introduction-to-jpa-with-spring-boot-data-jpa

many to many je tam ukazano, ale neni to vysvetleno
hledam ydroj kde by to bylo do hjloubky
anotace join table, cascade, mapped by atd
neco zakaldniho je zde

https://en.wikibooks.org/wiki/Java_Persistence/ManyToMany


many to many vyzaduje vytvorit join table kde jsou kombinace
obou klicu y obou entit

vyresit object ocrruption. kdzy se prida nebo odebere
na jedne entite tak se musi udelat spravna
akce na druhe entite, to se neudela asi samo.

jak? wiki jpa object cvorruption


musi se udelat jointable, ktera ma dva sloupce
jeden je foreign key ktery ukazuje na primary key
entity 1 a druhy sloupec je foriegn key
ktery ukazuje na primary key entititz2.
priamr key teto join tabukly je potom kombinace obou
sloupcu.

many to many je obousmerny v db, ale ne v jave.
aby to bylo obousmerne, musi jedna strana byt
owner, tzn ze entita ma anotaci join table
a
durha ma anotaci mapped by.





dobre zdroje:

http://www.springboottutorial.com/introduction-to-jpa-with-spring-boot-data-jpa
nemaji test ani jak se pouziva get by labels


dobre:
https://www.callicoder.com/hibernate-spring-boot-jpa-many-to-many-mapping-example/
nemaji test ani jak se pouziva get by labels

https://docs.oracle.com/javaee/5/api/javax/persistence/ManyToMany.html

tohle je dobre
https://en.wikibooks.org/wiki/Java_Persistence/ManyToMany

https://docs.oracle.com/javaee/6/api/javax/persistence/ManyToMany.html

http://www.objectdb.com/api/java/jpa

http://www.oracle.com/technetwork/java/javaee/tech/persistence-jsp-140049.html

i s testem, jak se to pouziva:
https://hellokoding.com/jpa-one-to-many-relationship-mapping-example-with-spring-boot-maven-and-mysql/
nemaji test ani jak se pouziva get by labels

many to many relations hip
anebo one to many jedna poznamka muze mit vice labelu

napr pozn 1, labelA labelB
pozn 2, labelA, labelC

a najdu poznamky, ktere obsahuji labelA, vrati to pozn 1 a 2

test noterepositroty
problem kdyz mi vrati repository Notes, tak je nemuzu porovnat s poznamkama co jsem tam
ulozil prootye note ma equals jenom pmoco atributu note a ne set of labels,
takze kdyz se vrati bez labelu, test projde. musim but zmenit equals
nebo v tesut naspat noovu metodu na porovnani
equals builders co to je?
varianta v tesu metodu



fopdoporcuucjou querydsl, ale to ma debilni instalaci viz
http://bsideup.blogspot.cz/2015/04/querydsl-with-gradle-and-idea.html
https://stackoverflow.com/questions/42198282/querydslpredicate-with-spring-boot-starter-jpa

tak zkuism bud

https://stackoverflow.com/questions/29431785/spring-data-jpa-query-value-in-a-set
1. jak udelat query na SET hashseht, to co mama ja

2. nebo jpa query language
https://docs.oracle.com/javaee/6/tutorial/doc/bnbtl.html

3. nebo se podva do sprig in action backend

nebo spring data jpa reference query -ne

udelat pres jpql nebo predictes? ne to v referenci nerikaji udelat hashset



-dodelat
aby progrm prisutpval do db pres notehnadler, cili bude mit metody na nahchazeni labelu i note
interface na notehandler notehandler pak ude volat z note repo a label repo metody

u


kdyz se do jpa uklada entita, ktera uz am je, tak udela merge, ale jpa musi nejak
poznat, ze uty tam entita je. nekolik strategii jaks e pozna ejstli uz entit aexistuje
4.2.1. Saving entities
v
https://docs.spring.io/spring-data/jpa/docs/2.0.2.RELEASE/reference/html/#repositories.query-methods.query-creation
The examples use simple <named-query /> element and @NamedQuery annotation. The queries for these configuration elements have to be defined in JPA query language
co to  je jpa query language?

ok uz mam test ten ale vraci jen jednu note a ne tu druhou, nevim proc labelA se vyhodnocuje
jako jiny od labelA,


najit aby jpa kdyz mu zadam labelA tak nasel oba dva. jak vhodnocuje ze jsou si labely rovny?
a kdyz uklada novy label proc nemuze dat odkaz na eistujici?

nkde jsem cetl ze v entite kdzy se pise equals tak by se melo zaskrtnout use subclasses.
protoze jpa ebo hibernate pri praci s enitta pouziva nejake proxy objekty a ty nemaji tu samou
tridu jako entit a aprooto equals entity vrati false

zkusim predela tequals a uvudim jeslti to pmuyze

@natural id ale jen hibernat e ane jpa

a co @column (unique) aby to nevztvorilo label 2x?
anebo @Id(genration stratgy identity) co t oje?

nejak to ouvisis s cascade merge, jeslti uz tam je v databazi tak udelej merge
https://stackoverflow.com/questions/38544196/jpa-unique-entries


https://howtoprogramwithjava.com/hibernate-manytomany-unidirectional-bidirectional/
ma many to many unidirieiotnal, vysvatuje kdo je parent a kdo cild
a ma o cascade a uklada to ty samy entity dvakrat jako ja
tam maji cascade all zkusim,

ve svym testu mam label1 a label2, obe maji stejny label "labelA", maji stejny equals a hascode,

zkusim test jestli equals je true a hascode je stejny, to je test.
kdyz to ibenrate ukalda do db, proc jim priradi jine id  aulozi je dvakrat?
jak zjisti ze jsou unikatni?
co kdyz v ramci jine transakce budu ukladat zas novou note  a bude mit stejny label
ktery tam uz existuje?

http://enterprisecraftsmanship.com/2014/12/27/dont-use-ids-domain-entities/
dobry poznamky

----------
posty ktery maj pdobonje problem jako ja many o many nefunguje
https://stackoverflow.com/questions/16460815/jpa-entityexistsexception/16463061#16463061

ma to vcetne thymeleaf a seurity, ale nema tam mana tto many unidierecitonal

https://springframework.guru/category/spring/spring-data/


------
dm si debug a uvidim kdyz dam note save co se deje, jestli se vola label save
a hlavne na jakym objektu se to vola? lze udela t vlasnti implementaci labela save
ktera se zavola kdyz se bude volat note save nebo note save vzdycky vyvola nejakou interni metodu
 kterou nebudu moct zmenit?

 a dalsi probeml je proc finby label nefunguje, proc neajde i tu druhou, i kdyby am byly
 duplikaty, tak to nefunguje.


 child je note a parent je label. vkladam parent do child.
 takze chci najit child by parent

 https://stackoverflow.com/questions/45554882/spring-data-jpa-how-to-fetch-parents-by-child-id
 blizko nebo to je to ono


 --

 kdyz jsem mel man yo many cascade all a poustil jsem tes notehandler save
 a ukaldal jsem note ktery uzmelo zpracovaney labely s id, tak hbernate
 vyhodil vjzimku, ze nemuze perisostvt detached entity. proc?
 mel bycch vrait nejaky cascadoani? merge a  persisit?

 mam dat nad neco @transcantional?

 pridat na sloupecek unique, constirant pro db.

------
o projektu business logika a pravidla

ukladani notes a k nim prirazaenych labels 0 az N.
hledani vsech labels, heldani vsech notes.
hledani podle parametru:
-note ma popis
-note popis obsahuje
label ma popis =
   opis obsahuje
hledani notes, ktery maji urcity label, ci labely vararg - AND musi mit vsechny labely
podivat se jaky sql se genruje, prochazeji se vsehncy notes a hleda se jestli ma label
nebo je to chytry a anjde to id labelu a pak se diva do tabulky notes_labels?

v db existuje jen jenden label s urcitym label
v db existuje jen jedna note s ucitou note, bez ohledu na labely
kdyz v db oexisutj note s labely 1,2 a uklada se note se stejnym popisem a jinymi labely 2,3
tak se
A/ vyhodi vyjimka a nic se neulozi?
nebo
B/ se nova neulozi a vrati se stara?
nebo
C/ nova prepise starou?

A/ to jsem rozhodl



---

jak muze web strnka poslat jako parametr list labelu? thymeleaf umi vztvorit
query s parametrama? nebo to bude json?

to jde, stranka umi udelat v query list a controller to umi odchyit jako list stringu a ulozot
do promenee
viz

https://reversecoding.net/spring-mvc-requestparam-binding-request-parameters/
bod c 6 list


---

jak udelat v repository metodu ktera najde notes s promenlivym poctem

jpql? asi ne
http://www.objectdb.com/java/jpa/query/jpql/collection#Criteria_Query_Collection_Expressions_
asi jen ze entita ma property typu string a query na property in collection.

slo by udelat metodu ktera vytvori sql string pomoci pridavani and nebo join
a pak se spusti ale to je neohrabany

NEBO

nejak pomoci predicatu?

nebo

querydsl


to je ono boolean builder

********
https://stackoverflow.com/questions/32326922/querydsl-convert-list-of-booleanexpression-to-predicate
*********

postupne pridavat AND


nebo
ne https://stackoverflow.com/questions/10857377/using-querydsl-how-can-i-check-against-a-specific-object-from-a-set-of-objects-t
pomoci any a pak equals

spojit to s boolean builder a udelat programticky retez AND
podivat se i sem
toneni ono https://stackoverflow.com/questions/44830387/how-to-create-predicate-booleanexpression-for-many-to-many-relations-in-querydsl
to neni ono https://stackoverflow.com/questions/23077155/left-join-with-spring-data-jpa-and-querydsl/23092294#23092294



hledat na stack overflow querydsl collection many to many

navod na query
http://www.baeldung.com/querydsl-with-jpa-tutorial

pak se pivam an sql vytvorene hibrnatem ktere bude posilat, zjistim z nich jestli
je to nejak optimalizovany, pres tu tabulku post_labls atd nebo pomoci joinu?
je to manualne pres najit vsechny notes ktery maj label A a prunik s labelB
anebo jeden pruchod tabulkou notes_labels a rovnou nalezeni jen tech zannamu  ktery splnujou
podmnku label a i B?

-----

jak na querydsl
napred najdu navod jak na spring data jpa a gradle  a anotac jak pridat do projektu
pak jak se tvori query, kam se pisou, jak se sposutej,
jak se do repositroz pridava podpra querydsl
pro jaky providery querydsl funguje?

depedecies:

http://www.mindissoftware.com/querydsl-note/

https://discuss.gradle.org/t/querydsl-with-build-gradle-integration/24595/2


https://discuss.gradle.org/t/integrating-spring-boot-querydsl-into-gradle-build/15421/2
http://bsideup.blogspot.cz/2015/04/querydsl-with-gradle-and-idea.html
https://stackoverflow.com/questions/35786422/how-to-use-querydsl-sql-spring-under-gradle

kdyz jsem dal build task tak mi to hlasilo chybu ze to nemuze najit nejakou c/users/polnksy/gradle/blabla cache.properties
nasel jsem tu chzbu na gradlu, upgradova jsem gradle

pmoci gradlew wrapper a ptom jsem spusit gradlew a zkusim
znovu build
buidl failed, test failed, jedne test byl prazdny, tak jsem ho smazal.
znova buidl
a ano build se udelal, usper, ted zkusim dat bootrun dobry bezi


nalseudju
http://bsideup.blogspot.cz/2015/04/querydsl-with-gradle-and-idea.html
zatim jsem upravil build.gradle, upragodav jsem gradle, povolil v idee aotace  a funguje buidl a bootrun
a pise mi to neco o anotacich pri buildu.
do build slozky mi to pridalo tridy glabel a qnote.




kam pisu query? co udelam s reposiroty?
pdoivam se do porjektu ktery je soucasti navodu

jpa query se vztvatri pomoci entity mangera, ten se deklaruje jako atrbuti tridy
a da se nad nej anotace @perist context.
podivam se jak se o pouzia ve sprign bootu, mozna to je jinak

https://stackoverflow.com/questions/46034154/use-entitymanager-in-springboot
zkusim pridat jen pers context

vbtvorim jpa query a pak instanci qnote, nejde mi QNote.note, jenom note1.
zkusim

vytvoreni query ctu zde:

http://www.baeldung.com/querydsl-with-jpa-tutorial

udelal jsem v not ehandleru query a ono to funguje parada
test pada na tom, ze potom hledam note podle labelu, ktery v db neexistuje.
jak to vyresit? je blbost ukladat ten label abych s nim mohl dal pracovat a hledat podle nej
ale to sem uze stat i pri hledani find label by label ne?
org.hibernate.TransientObjectException: object references an unsaved transient instance - save the transient instance before flushing

mozna transaction nebo flush? session?

//todo
nebo upraiv metodu hledani note podle labelu
projdu vsechny lbely a pokud mezi nima bude nejkay ktery neexistuje v db, tak vraitm praydny list
note a pokud tam bude, tak ziskam z db tu entitu a ulozim do listu.

//todo
anebo do jpaquery dam do contains ne label, ale exprsiion<label> to mi totiz nabizi metoda jako vsutpni
parametr.

//todo
jestli notehandler.findbyLabels ma brat seynam Labelu nebo Stringu?
stranka udela co? v parametru query?
kdyz na strance bude vypis labelu, tak uzivatel zaskrtne labely ktere chce
a ono to nejak samo udela list Labelu? pomoci postu a nastrak to do controlleru jako list labelu?



--------------

napsal jsem metodu ktera vraci prepravku a z ni lze urcit jeslti
label je nebo neni v db.
abyh metodu otestoval pridam spock a udelam stub z repositotry.

jak se pridam spock do spring boot porject?


udelal jsem cast metody findbylabels ktera vraci notes. jednu pomocnou meotdu kterou tato eoda
vola jsem uz otestoval a ok.

ted tesutju tuhle. udelal jsem test ve spocku s where. v setup spoka je repo delete all.
pri druhym testu se vyhodila yjimak ze to nemuze smayat, to vypada ze se vola znova setup
jinej delete tam neni. takze spock najit aby se zavolal setup jen jednou pred vsema testama
a vic ne.


navod na vytvareni query
https://dzone.com/articles/spring-data-series-part-3-typesafe-query

to neni ono
https://stackoverflow.com/questions/10857377/using-querydsl-how-can-i-check-against-a-specific-object-from-a-set-of-objects-t


musim najit boolean builder




https://stackoverflow.com/search?q=querydsl+many+to+many
to neni ono https://stackoverflow.com/questions/44830387/how-to-create-predicate-booleanexpression-for-many-to-many-relations-in-querydsl


nasel jsem boolen builder a upravil query dsl query pro jpa querz v metode findlabels.
uz to funugje, parada, prochazi se list, udela se query postupne a jde to.


//TODO ===========================
repository pridat querydsl repository a notehnadler ji preda predicate. NE
2//todo odstanit z repository find by labels ktera nefuguje, OK
3//todo dat hibernate debug a divat se jaky query spostui jeslti jsou optimalizavany.
4//todo metody z testu pridat do command line runner a podivat se do db onsoli a spusitt tam hibenrate sql
5//todo dat testy notehandelru do dvou spock testu
6//todo prejmenovat notehandler na DAO
7//notehandler do data balicku
8//dao pres inerface
9//pridat delete label OK
10//pridat delete note OK
11//pridat update label a note OK
12contrianty na entite napr unique pro note a label
13//todo udelat fornten
//vypsani vsech note pageable
//vypsasni vsech labelu pageable
pridani labelu
pridani note
hledani lblu
hledani notep odle labelu
jina databaze
rucni nastaveni databaze, nastaveni pocaetniho stavu db
pres liquibase

security
jenkins, profily deplozyovani


1.
repository pridat querydsl repository a notehnadler ji preda predicate.
docela komplexni ale moc tezkej priklad je tadyy
https://www.javatips.net/api/spring-data-jpa-master/src/main/java/org/springframework/data/jpa/repository/support/QuerydslJpaRepository.java
bez priklau:
http://www.mindissoftware.com/querydsl-note/
 trva moc dlouho njit prioklad, preskakuji

2//todo odstanit z repository find by labels ktera nefuguje, OK

3.vsechny metody vraci prazdny list a ne null. pokud raci label ci note, vrati null OK

4. valdiace vstupnch dat, napr ulozit label s prazdnym stringem null neo whitrspae spis vyhodit vyjimku a vratit na web nez vratit null
stejne tak u mazani neexistujich veci? vhodit vjimku a jak ji zobrazit uzivateli
opravit save label kdyz uz existuje

5,. otesotva tvschny metody notehandleru ok


11//pridat update label a note OK

update note

pres ntor hndler
pvni ykozntroulej jeslti eixtuje podle id,  boolean exists
na webu si note nekdo tevtre tim ze vyvola z db a bude mi tnejaky id
bude prsisovana, udela zmeny, zmeny ulozi.
psila tedy persistovanou entitu s id, ale jiny popis a jiny set.
pak zavolam metodu update na repository, ta by mela zmenit i zaznam v join table.
jak to zkontorulju?
podvi se do tabulky cosoli

crud repositrz pry kdzy se da sav tak se udela update pokud to existuje

a tady je prikad jak preest thymeleaf form na entitu
https://stackoverflow.com/questions/24420572/update-or-saveorupdate-in-crudrespository-is-there-any-options-available






9//pridat delete label OK
10//pridat delete note OK
napred musim udelat update note

delete label je tezsi.
delelte label podle id musi to uzivatel najit na strnace, pak je jistota ze existuje
napred check podle id ze label existuje.
najdu jestli nejaka note ma referenci na note.
ziskam tedy lost note, pokud je prazydny ak vymaz label

pokud ne, tak pro vsechny note proved metodu remove label.
metod removde label bere jak apramter note a label
udela remove ze setu a pak udela update note, pomoci metody udate note.

delete note
kontrola jeslti existuje podle id a pak je rpeositoru delete a ykontorlovat
tabulku join







13//todo udelat fornten

thymeleaf
spring guides,
spring in action



napred udelam stranku na save a label
/savelabel.html
form kterymu predam prazdy objekt label?
form udela post na savelabel.html
metoda to zpracuje posel data a presmeruje
na stranku /label/id1234

controller na yobryeni

pak n save a note






https://stackoverflow.com/questions/30423478/thymeleaf-binding-collections

https://stackoverflow.com/questions/35856812/accessing-model-attributes-in-thymleaf-and-spring-boot

to tse taky tyka myho zadani

https://spring.io/guides/gs/testing-web/
testovani contorlleru bey celzyho springu, jen web layer
navic muzu mockovat a mock contorleru podsoupnout

delam strukturu strnake,  a tkay layout
https://html5-editor.net/
ude;a html kod samo

https://reversecoding.net/spring-mvc-requestparam-binding-request-parameters/
dobry o bindovani requwes tparametru na parametry metodz

https://stackoverflow.com/questions/17964841/how-to-get-param-in-method-post-spring-mvc
pro post se pouyiova
@RequestMapping(value = "/", method = RequestMethod.POST)
public ViewForResponseClass update(@RequestBody AClass anObject) {
A body like JSON or another data representation would depending on your implementation (I mean, consume and produce MediaType).

Typically, multipart/form-data is used to upload files.
jak spravne poslat form?

tohle je nadejny
http://www.logicbig.com/tutorials/spring-framework/spring-web-mvc/spring-message-body/
jak se navaze obsah POST na argument, jak se dela content type




yde jsou priklady
http://javasampleapproach.com/spring-framework/spring-mvc/spring-web-mvc-form-submission-spring-boot


ykusim proste porid regquest body a typ dat jako Label, dam do testu mocmvc print aby to ukazalo jaky encoding
anebo v porhliyezi se podivam na request ktery posila stnaka s ofmrualrem

takye kdzy se posle form tak contet tzpe je Content-Type:application/x-www-form-urlencoded
a presto spring mvc z toho umi udelat entitu label a ja chci tu entitu dosta
jako paramaetr do metody, zkusim dat request body a parametr a pak bey request bodz jen jak paramter
bez request body, jen jsem nechal v prametru contolleru Label label a ma tam ta data z formualre
label uloziym, zisam novou entitu uloyenou a tu predam modelu

mam v label uz tu nentiua ted ji chci predat na zobrazeni. delam v parmatru model model a pridavam attobutbe
name  a label a zas chba.

ctu o model a model map. odkud se berou?

tka chyba vznika tam,ze kdyz sep osila post z formulare, tak spirn neumi prevest data na pbjekt tzpu
label ale proc? kdyz tam encham anotai modela trribute tak to funguje.
co dela anotace model attribute?
potom do prommne leabel se opravdu namapujou data z fomrulares
ale zase kdzy se podivm na documetac k modelatibute tka tam pisou, ze se to nepouyiva k mapovani fomrulare
na POJO, ale  k pridani pojo do modelu. divne

jeste zksuim pridat do controleru consumes form atd




jakto ze jim fungovala?

funguje to s mdela ttbirbute ale ja nechi jeste pridavat label do attrubtu a navic podle documetace
to se chova jinak.

http://www.baeldung.com/spring-mvc-form-tutorial
tady neco pisou o @modelattribute ale stejne to nehapu, kdzy neni parametr metody oznacen modelatrubte
tak se argument nebere z modelu. ale kdyz jsem to dal pryc tak stejne spring bral data
z formulare a chtel je dat do labelu

https://dzone.com/articles/using-spring-mvc%E2%80%99s
tady taky mluvi o tom ze se v pozadi berou data z modelu, ale jakyho kdzy model neexistue?

http://www.baeldung.com/spring-mvc-and-the-modelattribute-annotation
tady vzsvetlujou jka se z modelu ale jakyho modelu kdzy neexistuje? anebo
je tim modelem mysleno data z requestu?


 staci kdyz vim jk to pouyit/
do parametur dam model attribute nejak to nazvu a Label label
to udela ze to ezme data z fomrulare a uloyi je to mdelu a do parametru
vyhledem k tomu, ze metoda save zmeni label, ten samej, nevztori novou isntanci
ale meni existujiic, tak v modelu se taky objet ymeni, reference je stejna, takze
neni trba updatovat model.



//todo validovani vutpnich dat priklad je v e psirng in action kaoitla thzmleaf
//pridat exceptiony a udela terro page na exceptionz,


//todo pidat do kaydz stnrkz navra tna menu
//redirect po uloyeni aby se nepostovlao dvkrat atd

udlel jsem sav enote ale dla jsem do meotdzy jako parametr dvakrat model atrbute a tne druhy to inguruje jak to muzu napravit?
jak zaroven poslat dve entity?

podivst se sem
https://docs.spring.io/spring/docs/4.0.x/spring-framework-reference/html/mvc.html#mvc-ann-form-urlencoded-data

https://stackoverflow.com/questions/34782025/http-post-request-with-content-type-application-x-www-form-urlencoded-not-workin/38252762#38252762
nema tam @model att a presto to funguje? jakto?

udela manualne bindovani pres responsebodz a dat do mapy dat jako note, popis, label popis,.
ale jak se udela z toho list nebo set? prootye to bude label= a ynova label= a to v mape bejt nemuze

napr tady
https://stackoverflow.com/a/4339291/7747753

jak se dela rucne meneni dat na objetk
https://stackoverflow.com/a/31083802/7747753
https://stackoverflow.com/a/31083802/7747753

mozna zde:
http://matthewsalvatore.blogspot.cz/2013/08/spring-framework-working-with-x-www.html


tady je test mock mvc n aposilani POST  a parametru
http://www.logicbig.com/tutorials/spring-framework/spring-web-mvc/spring-message-body/

listy
https://stackoverflow.com/questions/34789357/how-to-pass-liststring-in-post-method-using-spring-mvc

jak z myho formulare ktery ma polozky label yiskam bud obejtk note se setem labelu
nejak auotmaikz
ebo alepsion jak yiskam automatick zojek tnote a automaitkcz list stringu nebo list labaleu?
hledat spring mvc form POST list
a taky se podivat do navodu k thyeleafu tam je nejaky ukazkovy poejtk a jedna entita ma myslim v osbe set nebo list
tkaye kdzy e ukada do rmlulare, musi to nejk pracovat


th each kdzy se prochayi list a dava do thymeleaf
http://www.thymeleaf.org/doc/tutorials/3.0/usingthymeleaf.html


tshal jsem projekt thzymeeaf ktery posila formular postema  a ma tam array  a sam to preklada
nechapu v porjektu thymelepra se nejak samo udela z formulare post entita vcetne vnorenych arraye Feature. nevim kde to je nastavene
nevim ja udelat debug maven projektu s tomcatem v gradlu udelam debug


nasel navod zde
tkzy maj entitu ktera obshauje lsit jinych entit
a doastava halnvi entitu v parameru
http://viralpatel.net/blogs/spring-mvc-multi-row-submit-java-list/

napdal ome ze moyna je konflikt s label jako nazev objektu a label jako nazev attributu labelu, prjemenuju?
podivam e na fomrular jaeslti tam ma objet spoeciifikovany ajak se jmenuju name input tagu

yde jses videl ze v htm kodu musi byt labels[0].label  a label[1].label, tak to je  projektu thymelleaf, input type text
a name = rows[0].desc a rows[0].date atd a pak strnak posle PSOT a bude tam sprvne parametry a spirng z toho udela spravne
entitu ale podle W3C se v name nesmi vyskytovat znaky [].

ykusim to udelat taky s
labels0.label

a taky labels.label
a pod tim labels.label
jestli z otoh udela psirng list labelu, v query to funguje ze tomu samymu key priradis nekolik hodnot a on z yoho udlea losi tspring


v thzmeleaf maji v htm kodu taky name=features a dalsi input name=features a spring z toho udela array Features a Features je enum, ma to jenom name atribut.

mam tam labels[0].label zda se ze to funguje alae hlsi to chzbu prootoye je to set a ne labels
tak bud najdu navod kde se pouziva set

anebo napisu handlerhhttp mapper kterej udela z listu set, anebo d oentity
pridam propery labeslist a ta bude brat list a jakmile se vyvola, tak prijme list , z listu udela set to ulozi do do labels
a pak ulozti set do listu aby to bylo sznhroniyovany. ale nevim jak bude fungovat add a remove z listu a setu.

taky muzu hledat na googlu <form method=post
request mapping post nebo postmapping
@modelattribute
a Set<

zjisyil jsem ze spring neumi udelat binding na z formu na set to je blby

budu set udelat rokaaround.
kzdzy zmenim set na list tak porusim many to many, budou tam mo byt duplikaty a to jejblbe.

cioi ptebuju logiu setu, ale interface labelu.
zkusim najit exisutji adapter ktery vzpada yvenci jako list ale je to set
a kdy ne tak udelam vlasnti

v Note bude list labelu a ten list bude final. aby se nemol prepsat
setter metoda bude jen delat to ze vymaze z myho objektu ListSet vsechno a ulozi do nej
vsechny hodnoty y prichoyiho listu.

muj objetk bud extendovat arraz list tim ydedi vsechnz impelemtance metod ydedi taky implemenataci listu?

override jeho metdy add addall atd yavolam super add ale pootm removde duplivcatess.

//todo zmeni se neco kdyz misto set bude list? volam nejaky metody Setu a kdzy to bude List bude to fungoavt?
odivat se na interace fe set jesli ma neco navi nez list.

https://stackoverflow.com/questions/45948833/spring-mvc-form-post-with-object-inside-collection-objects-of-model
ma podobny porbelme potrebuje set a musi se to tvarit jako list.
muyu mu odpoedet

vzpaa to ze set nema nic navic oproti collection tim padem ani oproti lsiut


blbyje ze nemuzu udleat emtodu get labels ktera by jednou vracela set a druha list.
nevim kdz bude java nebo spring nebo hibernate volat getlabels a kdyz to prejmenuju na getlabelsSet tak to metodu nenajde/
jeste ykusim abz get abels vracelo typ, ktery bude vzhovoa i  listu i setu.
jak?

asi nejde
jde aby interace ydedio od dvou ano jde

udelam intrface LISTSet ten extenduje list a set a potom muj list bude typu LITSET ale implementace bude plsitsetimpl a bude to dediet
y listu a tim yiska jeho metdz a prepisu jeste set[i] aby to porhledal duplikatz a pokud ne tak zaoala super a kdzy bude neluloyi
prpeisu add a adda ll

zkusim vsechnz metod get labels a set labels anjia  z yjisit jeslti opravu usi mit set
a predelam to na apache coomons unique ist a bude to tzpu list



//todo ykusit dat do listu stjeny hondotyz jeslti je to vradi aby to bzla Set
 v

 https://docs.spring.io/spring/docs/3.0.x/spring-framework-reference/html/validation.html
 tady se dela manualne asi binding yde je popois

 n//todo nebot udelat cely s listem a jenom dat nad db contrinats ye column label je unique a odzchyiy
 vzjimku db a predat ji view aby to yboraybil samoyrejme odhztitm vjimku db, podle typu, a vzhodim nobovu vjzimku
 s nejakzm popisem o duplicite.

 vsude jsem rpedelal set na list a padaji tri testy. asi blbne quelas a ascode,
 davam febug
 na tetu de se porovnanvaji listy

 haschde se meni s poradim v istu

 cili abcyh udella sprvny hascde musim listz seradit a pak zavolat hashcode List.haschde nebo tak
 abuch mohl isty seradit tak musi by labely seraditelne a abch

 a ptom jest meussim ymenit equals na mym listu I aby to delao contains all A do a B do A
 anebo pres haschcode, jen to porovan haschode a je to ok

 tak jsem to uz zjistil, kdyz se uklada entita, note tak se zmeni labelsetI na persistnet bag, i kdyz je to final atribut
 ppodivam se v jakym kroku dojde ke ymene

 prtoye udela uplne novou insanci a do ni nasype data a kdyz je ve tride typ List tak tam da jakoukoliv implementaci.
 zskusim dat do tridy misto listu te SetListI a sksvalne jeslti m to veyme form bidign. teoretickz by mohl kdyz necham signatuu metody
 setlabels na listu tak signatura sedi.
 kdzy se vola get labels tak do dignaturz nepoatri navratovy typ, snad bude ok.
 kdyz budou volat list.set0 neco tak snad taky ok.

 roybilz se navic testy ale proc?

 neufnguje hashcode a navc se royiblz i testy

 hascdoe udelam  primo v listu. udelam itercfi for nad novzm sorotnaym listem.
 v jakem poradi se ituruje po sorotvani?
 njit na netu.

 predelat equls na contains all boustranne.
 dat debug na haschode.

 mona udelt testna haschode ve spocku?




 

po save uz se nevyvola metoda hashcode na SetListI, mam tam sout println a to se nezavola.
jakto ze se behem savu zmeni list tak ze se nevol metoda hashcode na listI ale na necem jinem?
kdyz je to final a navic setter emtoda neprepisuje jenom dela clear a adda  lll?
mozna ze add all meni list nebo clear. ale mela by to byt porad instnace seetI
deubg

po save uz jsou labels ne setlisI ale persistent bag. jakto? hibenrate smaze instanci  a nahrdi ji
jinou? jak to muze udelat? mozna ze nezmeni samotny list ten nekde vezi, ale do instance note
nasype referenci na jiny objekt.
zkusim teda do entity Note dat objet misto List tak SetlisI aby kdyz hibenrate dela novu note
aby tam musl dat zas to moje.

konsturktor aby kdzy to hibernate stavi znova i kdyz do note chce dat nejky list
aby stejne to najonec skoncilo jako setlistI
mam tam final ne?

debug bych nasel okamyik dkz se ymeni lis t na bag

meni to save dobre debuonai by trvlao dlouo proste to meni
zksuim zmenit v objektu tzp na muj list. udelam zas type migration. nem nemuim . co getter? nevadi ye vraci setlit protoze metodz ocekavaji list?
to se nemeni a setter bere lis tto se nemeni

udelal jsem z setlist i bean a dal ji scope na prottoz, pokazdy nova isntance

psuitj se to,  hibernate si steuje ze jsem oznal jako one to many atrubut ktery neni colekce. jak to ale? vydzt setlist implementuje collection?


kdybych tam nechal Lsit = setlist I a hibernate vztvoirl odynova novu instanci note stejne
by s mela vytvorit s setlistI a ne s nejakym bag, vsechnz konstruktory a settery
stejne neumoynujjou udelat nic jinyho ney new setlistI

Illegal attempt to map a non collection as a @OneToMany, @ManyToMany or @CollectionOfElements:
tkusim tohle obejti
nebo se podiva tjak vztvoari noovu note

hibernat bere taky jako meny tao many colleci ktera je royhrnaim custm
kdyz udelam tedy setlistI impleents cusotm huibernate
 a pak hibenrate udel acontrukc note, tak aby tam dosail
 implemtaci cutom interfce bude tam muset dat moji instanci anebo
 tam naszpe vlastni objekt ktery taky ompelmetuje cusotm?


vdebuu jsem to endochti nejak to zmenil muu s dat ayarayku na new note a taky na private final lsitt/....

dla sem si debug na ne wnote vsechn konsturktoryz lae pri save se nezavolaal, asi to dela nejak jinak relfexi
ye to neprojde standarndnim konturkotrme.
dobre tak cesta je ze po kaydzm save nevratim repsoitorz save, ale udelam klon a tem muj koln
bude nova note
a ta bdue uz spravne.
a tak find note, vsechn not ehandler meotdy ktery vraci Note pouyijou koln.

yavolase return vracena note.clone a ta vrati noy objetk.

ventir se udela nova note a tz se naszpu presne vsechn obejktz note, labels a id atd.
pritom klonovnai vseho se deleguje na samotne objektz.

udelam copii pomoci konturktoru, clone je lby prej


tstu nefuguji proote dva testu nejde spsutit sie ye to nemuye najtitridu s testy.
to se i yu jednou tstalol restuuju ideu. zkosuel gradle refresh, gralde lcean atd

a nic.


jeste u save. bernate umi udelat to, ye kdz se vola repo.save
tak on vemze puvodni promennou obsahujici referenci na note
a do ty pormenn nastavi novou note, ktera je ale zmrsena.
anebo ymeni tu existujici.
ohuyel v metode save nemuzu ovlvonit aby se puvodni pormenna odkayovala na
validni kopii.
takze musim vzut navratovz hodnoty ze save

 udel ajem chy bu v equlas u senotI copz paste chyba nechal jsem tam
instance of LAbel misto setlistI pridebugu jsem to tobjevil

restar idea, ipridal jsem sloyku src test groovy a dal dva testy tam
posutim pres gradle test a jde to

jeste ze ty testy mam, u nekolika pouyiti testy spadly a to me upozrnilo na chybu.

spock mi del brodel s databyi, chova se to divne s Id presotye to ma volat
pred kaydozm testem setup, kde se do note1 ulyi ktualni note s id ta
pri deugu v note1 je idnull

spock se chva divne
i kdzy mel v setupu note = save note
a v debugu byla v promenee note spravna entita
s mym listem, tak potom pri given byl udelan list z note
a  vnem byla note sptana s persisten bag

testy bezi uz nevim jak jsem je oravil. nekde jsem misot note =save note ta bylo persis bag
tk jsem
dal new note


nefunguje bindovani z formulare do entit.
zkusim na stnace ruznou szntaxi.
ve formualri
name=labels.label
nae=labels.label
name=

pak budu gledat cutom adata binding
ziskam jn aalue map a tu predam sericve na zpracovani
od i

divny vzdyt to musi fungovat ve dvou priladech jim to funguje ze se autoamitkz ulozyi do listu

 @RequestMapping(value="/seedstartermng", params={"save"})
    public String saveSeedstarter(final SeedStarter seedStarter, final BindingResult bindingResult, final ModelMap model) {
        if (bindingResult.hasErrors()) {
            return "seedstartermng";
        }
        this.seedStarterService.add(seedStarter);
        model.clear();
        return "redirect:/seedstartermng";
    }


    neni tam zady model atibute

final SeedStarter seedStarter, final BindingResult bindingResult, final ModelMap model



uy mi funguje list babel, postupne to budu menit na aby to bzli stjene jako laell a v tom kroku ktery to roybije, to bude.
moyna jemno labels label?
entita Label a atribut label?

ymneim label na descirption

ne vztvoril jsm novou atribut List s jmenem babel udella gette sette a zavolla toa
a spravne to udelal oNote a do listu babel coz je array list
to uliyilo vsechnzy labely.
pak jsem do metodz getbabel a setbabel dal labels a debug,

sel js do mista, ktery vhodilo vzjimk.

zatim to porschyi, udelalao to setlistI get0 bey problemu
v abstract nestablepropertyaccessor metoda get nested property accessor radka 848  bezi to./

uy to zpracovava label[1].label a zatim ok nechapu ale jest to asi neprirayuje hodnoty do labelu.

a spadlo to.

domnenka napred spring nasype do listu na vsechnz indexy nejaky obejktz s nullama.
pak do nich pise. ale prootote to moje ostranuje dupliakz, tak na indexech kde neco ma
byt uloyeneho je null a hayi to null poiner excetioinl
a ajk list porovnava jestli uz obsahuje label s nullme? equals nebo hashocde?
prepeisu v Label tak aby label s nullama vzhodnitl jako jiny jak to udelam s haschodem?


to ejna to debuug divny dal jsem si debug na idnex of v seunigqulist.
tam byla metoda getlist().indexOf dal sem step into hodilo me to do
get list, pak reurn, dal jsem step into hodilo me to ypet na radek getlist index of dal jsem step into a
vyhodilo me to ven. jak se dostanu dovnit rindex of?

ale yjisitlj sem ye je ten get list vraci List ale za tim array lsit.
jak se podivam do kodu array listu?
asi dma rraz list v kdou a klinu na ctrl a klika to me doih do kodu?

ansel jjsem kod aaraz listu ano dela to pres quals, takey upravim labl ewualas a bude

prepalj sem equals v Labelu aby zustaly vsecny v unique lsitu a spirng do nich mohl uloyit.
je to sice proti OOProydeleni iodpvednosti prootyep odle chovani springu upravuju chvoani Labelu
a tak to vlasnt eporpojuju, ale neni jiny resei.
spring se spoleha na uritu vlastnost Listu, ye zkdzy nekam neco ulozina nejaky index tak to tam
taky najde.  a unique list to porusuje takze se to pak vlece.

spravny bz bzlo udelat custom bindera kterz umi pracovat se Setem

nebo jsem se mylil a spring umi bndovat data z formulare do Setu
vporpsetu accesorech bzla set tak proc to nevuyit.


asi slo jenom o sntaxi. ale jak vlasten udella spirng z e stirngu labels[0] label a index 0?
//todo ozkouset Set by bzl lepsi bylo by to bey opicaren.

a jest eneni equals u labelu hootovej NPE stalo se ze jede z labelu je null a tim padem equal z nullovzho stringu
dava NPE

enecham si udelaim ideou novje equalss  bude nullable label propertz

ale roybiju vaybu mezi hashcode a ewuals pro nullovy stringy labelu bude equals false ale bude stjenej haschdoe
podivam se do hashode. nebo pouyiju hscde builder a ansatvim tam null at dava jiny hash
anebo vzgeruju nhodny stirng  a ynej hascde?

jo ta to funugje uz se mi to uklada do note spravne a vcetne labels listu, parada
jenom to nechava v lsitu labely ktery maj praydnej stirng. emptz strun equals eptz stirg?melo z to vratit ruea a tim padem vzradit label z listu
debug

jest eudelam test ve spocku na label equals
a tes tna prdiavana do setu ze labely s null labelama se pridaji
a test na pridani label sproaydnym stringem abyt ot funovalo a pak impeetace


a pak udelam updat enote
a find note strnak aoc ntorllery



forma binding to entittz spring
http://keylesson.com/index.php/2015/12/14/spring-mvc-data-binding-list-example-2458/

http://viralpatel.net/blogs/spring-mvc-multi-row-submit-java-list/

problem je v otm ze neprjve do listu se pridlaji nukllove labely
to jsem zmenil ze jde a labelzy se podrzi.
ale potom se label.setlabel='' nekoliktrat. a to uz nejde pres list add
takze se nekontorluje equals labelu.

pridm do handelru ze pred kazdym save se provede napred, ze pre akydzm uloyneim se na note
zavola metoda odstran dupl labely, note si to vzresi sama, pres svuj uniue list, reved to na set a zpatk
ulozi do sebe.

totey pro updte

//todo predelat handeler aby napr save nebylos vayzna y s note a label, ale obecne pres interface
a interface by melo vratit hontou, ktera ma byt jedinecna v db. ale jak?


napr test vztvori note kde bduodva labelz s empt string labelem, uloyi hot  a metoda ssave vrati
note kde bude jen jedne labelnapred test
na listu, ak atest na note a pak test handelru

aby mol apsrne fugovat Set musi byt objekty v ni immutable. to je spravne
kdyby byl Label immutable jak by Spring vzplnil lael.label? ma na to nejakou jinou meodu
je to chytre ze by to rovnou vztvoilo obejt Label.label=neco a ten dalo do listu?

je to zakerny udell jsem tst na save note a kontorlaoval jsem jeslti to
odstranilo dupkiakty a yapomnel jsem v notehandler save prida remove duplicates
test prosel, ale jen dikz tomu, ye kdzy se savuje tak
to vraci validovanou kopii a ta v sobe provede rovnou odstraneni dupkiatu
ale v databayi byly dupikiatz.

tak jsem to ymenim.

udel ajsm i test na dupkiaktz pri update.

v updat ejsem vuyil existuji ci metodz save new note, ktera obsahuj vracnei
validni kopie note a navic dupliatz to je vzhodny
kdzy se pouyvaji metodz vicekrat.

 note controler uz umi navayat entitu na naote, doplni do ni labely
uloyim note, znova to stirng a uz vni enjsou labely dupkiatni.

jenom formuaor posila praydnz stirngy. chtel bych se jich ybavit.
kdy? idelani pri save a udpate. predelat testy. v rmaci removeduplicates and emptz labels.

udel ajsem testz na update a save a mam htoov, testy ok



dstnaka ifnd note bz noe

udela htm stanku

contorller odkay na view find note bz te
tam dofmular s postem jediny stirng
//todo yemnit na obsahujici note a ne exact match vratit list note a ne jednu

//todo udelat stejnous tanku por find note y note pro jednu i pro vic pomoci foreac
iterova tlist


ale bude to rzhclejsi?
ydrzeni je to ye musim sposutit apiacki a to trva dlouho.\
otayk ajessetli restartovani bude chlejsi nebo ne.

trva to asi 23sekund.
a reatt?restar trva si tri sekundz

upravuju souvbor java a pak dam v idea build -> build moduel  web2
tim se ymeni soubry v class path a to dev tools mionitorujou
a restartujous 

udelam hledani podle note contianing note
napred test, pak udelat handelr metodu
otestovat
uprai cintrooller
a html soubor.

totey pro label

mam est a impelenta ci pro note contin note stirng
ale testy neprochayeji a je to kvuli tomu ze mam list expected contins al l listt real a rela contirns all
expected a to nefunguje,
vola se note equals, ale z neajyho zahadnyho duvdou se do listu pro pasuje note ktera ma persistne bag,
ael pritom ve spocku testu ma v setupu note1=save(note1) cili v note 1 musi byt spravna instnce s unisetlist, ale neni

tu nespranvou note1 potom do myho tetu hodi spock. zkosuel jsem debugem projit na to kde se to deje ale marne
ostanti testz funguji i kdzy tam maji note1 a tam to neni probme, ale ostanti testz
tesutji listz ne pres contains alle res list==list. zmenim
ted jsem psutil celou tridu handlerspec2 a vsechno ok, moje metoda containung dva testy ok a dva ne ok, pritom v tech failujicich
se obsah shoduje naprosto takze je to jenom tim perist bagem


//todo nejak provazat jmeno html soyuboru s request mapping a taky se stringem v html strance href
//todo udelat sript ktery naplni db
//todo do menu html vlozit textove parametra hrefu


find notes by labels contians
moznost dat vic labelu a label se matchuje podle contains

napred test


impemematac

nemuzu njit tu dslq uery

udelam delete


note delte je htoovo 

label delete je hotovo. save label je hotovo, seel allabels je hotoov 

jdu na update note

=============
k nalezeni note podle labels contians.


list stirngu
1abc

2def

3xxx

najdu napred labely v db ktery vyhovujou abc - skupina labelu 1
najdu napred labely v db ktery vyhovujou def - skupina labelu 2
najdu napred labely v db ktery vyhovujou xxx - skupina labelu 3

hledam note ktera




https://stackoverflow.com/questions/44830387/how-to-create-predicate-booleanexpression-for-many-to-many-relations-in-querydsl


a.listOfB.any()
      .id.in(list);
      pry to funguje.
      myslel jsem ze any proste matchuje any, ale tady je dalsi podminka, anym, ktera splunu jepdminku

      muj pripad by byl note.labels.any().in(matchin glist

      https://stackoverflow.com/questions/23077155/left-join-with-spring-data-jpa-and-querydsl/23092294#23092294
      tady to rozebriaj vuice

     //todo co je join? left join, righ join, inne rjoin aouter join

     funguje updata label?
     funguje update note?

     //todo nahradit "/" + contsnta tya constnat a jeslti i farm aciton muze byt s lomitkem

     updat note:
     formualr musi posilat i note id. to bud einput type hidden. ale tim padem musim do strnaky\dat
     aby vzal z atrbutu note.noteid. ok

     ale u save new note bude atrubt note mit noteid null. jak se to zparsuje do input hidden value
    ?
    a kdzy poslu fomrualr save s titmo stirngem? prazdnym? bude z toho Note.noteId null?

    mam hotovo i mvc update note i label, save notea  a label a
    find note by labels contyianning i mvc

    co dale?

    jeste find label by label cotnianing\
    
    
    
    
    
    opravit nehezkost se setem a listem, staci pred ukladanim zavolat list distinct. tim apdem nebude muset byt ten setuniwque list
    
    a bude normalni equals atd atd. 
    
    slo by cascade? aby se ukladalo samo a ne ja rucne?
    knizka proJPA2
    
   
   ------------------------------------
   ---------------------------------------
   
   //TODO
   abyse ori gradle buildu psutily testy a vypsaly se vysledky
   0. opravit testy
   1.db do souboru.
   2.inject script, ktery na pocatku vlozi do db data. duplicita? Rozbije to testy. Lze mit pro
   testy jinou db nez pri spusteni aplikace? nebo jiny sping context?
   3. kdyz bude db v souboru, a zmeni se schema, datovy model, co se stane? JPA osetri? Liquibase?
   4. ukladani pomoci cascade? odstranit manualni ukladani labelu
   
   
   
   ---
   1. build ok, pousti testy. task test funguje.
}
